name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}

jobs:
  ci:
    name: fmt + lint + test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build CI base image
        run: |
          docker buildx build \
            --target deps \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/objectio:ci-cache \
            --cache-to   type=registry,ref=${{ env.REGISTRY }}/objectio:ci-cache,mode=max \
            --load \
            -t objectio-ci:${{ github.run_id }} \
            .

      - name: Check formatting
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo fmt --all -- --check

      - name: Clippy
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo clippy --workspace --all-targets --features isal -- -D warnings

      - name: Tests
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo test --workspace --features isal

      - name: Cleanup
        if: always()
        run: |
          docker volume rm ci-target-${{ github.run_id }} || true
          docker rmi objectio-ci:${{ github.run_id }} || true

  build:
    name: ${{ matrix.image }} (${{ matrix.arch }})
    needs: ci
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: gateway,       image: objectio-gateway       }
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: meta,          image: objectio-meta          }
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: osd,           image: objectio-osd           }
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: cli,           image: objectio-cli           }
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: block-gateway, image: objectio-block-gateway }
          - { arch: amd64, runner: ubuntu-latest,    platform: linux/amd64, target: all,           image: objectio               }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: gateway,       image: objectio-gateway       }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: meta,          image: objectio-meta          }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: osd,           image: objectio-osd           }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: cli,           image: objectio-cli           }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: block-gateway, image: objectio-block-gateway }
          - { arch: arm64, runner: ubuntu-24.04-arm, platform: linux/arm64, target: all,           image: objectio               }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          docker buildx build \
            --platform ${{ matrix.platform }} \
            --target ${{ matrix.target }} \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:buildcache-${{ matrix.arch }} \
            --cache-to   type=registry,ref=${{ env.REGISTRY }}/${{ matrix.image }}:buildcache-${{ matrix.arch }},mode=max \
            -t "${{ env.REGISTRY }}/${{ matrix.image }}:${SHA_SHORT}-${{ matrix.arch }}" \
            --push \
            .

      - name: Cleanup
        if: always()
        run: docker image prune -f --filter "until=168h"

  manifest:
    name: Create multi-arch manifests
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)

          TAGS="latest $SHA_SHORT"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAGS="$TAGS ${GITHUB_REF#refs/tags/}"
          fi

          IMAGES="objectio-gateway objectio-meta objectio-osd objectio-cli objectio-block-gateway objectio"
          for IMAGE in $IMAGES; do
            echo "::group::Manifest $IMAGE"
            for TAG in $TAGS; do
              docker buildx imagetools create \
                -t "${{ env.REGISTRY }}/$IMAGE:$TAG" \
                "${{ env.REGISTRY }}/$IMAGE:$SHA_SHORT-amd64" \
                "${{ env.REGISTRY }}/$IMAGE:$SHA_SHORT-arm64"
            done
            echo "::endgroup::"
          done

      - name: Package and push Helm chart
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            APP_VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="0.1.0-${SHA_SHORT}"
            APP_VERSION="${SHA_SHORT}"
          fi
          helm package deploy/helm/objectio \
            --version "$VERSION" \
            --app-version "$APP_VERSION"
          helm push objectio-*.tgz oci://${{ env.REGISTRY }}
