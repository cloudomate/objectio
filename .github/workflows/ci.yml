name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGES: gateway:objectio-gateway meta:objectio-meta osd:objectio-osd cli:objectio-cli all:objectio

jobs:
  ci:
    name: fmt + lint + test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build CI base image
        run: docker build --target deps -t objectio-ci:${{ github.run_id }} .

      - name: Check formatting
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo fmt --all -- --check

      - name: Clippy
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo clippy --workspace --all-targets --features isal -- -D warnings

      - name: Tests
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo test --workspace --features isal

      - name: Cleanup
        if: always()
        run: |
          docker volume rm ci-target-${{ github.run_id }} || true
          docker rmi objectio-ci:${{ github.run_id }} || true

  build:
    name: Build (${{ matrix.arch }})
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push per-arch images
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)

          for PAIR in ${{ env.IMAGES }}; do
            TARGET="${PAIR%%:*}"
            IMAGE="${PAIR##*:}"
            echo "::group::Building $IMAGE (target: $TARGET, arch: ${{ matrix.arch }})"
            docker buildx build \
              --platform ${{ matrix.platform }} \
              --target "$TARGET" \
              -t "${{ env.REGISTRY }}/$IMAGE:$SHA_SHORT-${{ matrix.arch }}" \
              --push \
              .
            echo "::endgroup::"
          done

      - name: Cleanup
        if: always()
        run: docker image prune -f --filter "until=168h"

  manifest:
    name: Create multi-arch manifests
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)

          for PAIR in ${{ env.IMAGES }}; do
            IMAGE="${PAIR##*:}"
            echo "::group::Manifest $IMAGE"

            for TAG in latest "$SHA_SHORT"; do
              docker buildx imagetools create \
                -t "${{ env.REGISTRY }}/$IMAGE:$TAG" \
                "${{ env.REGISTRY }}/$IMAGE:$SHA_SHORT-amd64" \
                "${{ env.REGISTRY }}/$IMAGE:$SHA_SHORT-arm64"
            done

            echo "::endgroup::"
          done
