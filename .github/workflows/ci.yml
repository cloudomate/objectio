name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    name: fmt + lint + test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build CI base image
        run: docker build --target deps -t objectio-ci:${{ github.run_id }} .

      - name: Check formatting
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo fmt --all -- --check

      - name: Clippy
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo clippy --workspace --all-targets --features isal -- -D warnings

      - name: Tests
        run: >
          docker run --rm
          -v ci-target-${{ github.run_id }}:/build/target
          objectio-ci:${{ github.run_id }}
          cargo test --workspace --features isal

      - name: Cleanup
        if: always()
        run: |
          docker volume rm ci-target-${{ github.run_id }} || true
          docker rmi objectio-ci:${{ github.run_id }} || true

  build-and-push:
    name: Build & Push Docker Images
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - name: Login to registry
        run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "${{ secrets.REGISTRY_URL }}" -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Build and push images
        env:
          REGISTRY: ${{ secrets.REGISTRY_URL }}/${{ secrets.REGISTRY_PROJECT }}
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)

          for PAIR in gateway:objectio-gateway meta:objectio-meta osd:objectio-osd cli:objectio-cli all:objectio; do
            TARGET="${PAIR%%:*}"
            IMAGE="${PAIR##*:}"
            echo "::group::Building $IMAGE (target: $TARGET)"
            docker build \
              --target "$TARGET" \
              -t "$REGISTRY/$IMAGE:latest" \
              -t "$REGISTRY/$IMAGE:$SHA_SHORT" \
              .
            docker push "$REGISTRY/$IMAGE:latest"
            docker push "$REGISTRY/$IMAGE:$SHA_SHORT"
            echo "::endgroup::"
          done

      - name: Cleanup
        if: always()
        run: docker image prune -f --filter "until=168h"
